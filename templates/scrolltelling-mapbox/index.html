<head>
<!-- ------------------------------------------
Copie o head abaixo e cole no seu template
------------------------------------------ -->

<link href='https://uploads-ssl.webflow.com/5d88f370c5599e348fb22cbe/5d8b9e9b916e2bac8bac604b_mapbox_gl.txt' rel='stylesheet' />

<meta charset='utf-8' />
<title>Mapbox Storytelling</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v2.0.0/mapbox-gl.js'></script>
<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v2.0.0/mapbox-gl.css' rel='stylesheet' />
<script src="https://unpkg.com/intersection-observer@0.5.1/intersection-observer.js"></script>
<script src="https://unpkg.com/scrollama"></script>
<style>


    .mapboxgl-canvas-container.mapboxgl-touch-zoom-rotate.mapboxgl-touch-drag-pan,
    .mapboxgl-canvas-container.mapboxgl-touch-zoom-rotate.mapboxgl-touch-drag-pan .mapboxgl-canvas {
        touch-action: unset;
    }
    .mapboxgl-canvas {
    -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
    }
    .mapboxgl-canvas:focus {
    outline:none;
    }
</style>

<!-- ------------------------------------------
Copie até aqui o head
------------------------------------------ -->
<link rel="stylesheet" href="local.css">
</head>

<body>
<!-- <div class='frames'></div> -->
<!-- ------------------------------------------
Copie o body abaixo e cole no seu template
------------------------------------------ -->

<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v2.0.0/mapbox-gl.js'></script>
<script src='local.js'></script>

<script>
  var config = {
    style: 'mapbox://styles/caiojacintho/ckyu4kjqz000a14p7kivbajq6',
    accessToken: 'pk.eyJ1IjoiY2Fpb2phY2ludGhvIiwiYSI6ImNreXVmeGNjeTBiaGczMm1sYTAzc2EyNWwifQ.gmZ0eUpq0-tgaQb3tJ0PiQ',
    theme: 'light',
    use3dTerrain: true,
    chapters: [{
      id: 'riodejaneiro',
      // mapAnimation: 'easeTo', // flyTo, easeTo
      location: {
        center: {
          lon: -43.41869,
          lat: -22.95622
        },
        zoom: 10.85,
        pitch: 27.00,
        bearing: -2.79,
        speed: 2,
        curve: 1
      },
      rotateAnimation: {
        duration: 100, // seconds
        degrees: 180 // degress
      },
      mapAnimation: 'flyTo',
      // callback: 'newContainer', 
      onChapterEnter: [{
        layer: 'municipio',
        opacity: 1,
      }, ],
      onChapterExit: [{
        layer: 'municipio ',
        opacity: 0,
      }]
    },
    {
      id: 'bairro',
      location: {
        center: {
          lon: -43.25119,
          lat: -22.88566
        },
        zoom: 14.98,
        pitch: 8.50,
        bearing: -34.70,
        speed: 2,
        curve: 1
      },
      mapAnimation: 'flyTo',
      onChapterEnter: [
      {
        layer: 'jacarezinho-full',
        opacity: 1,
      }
      ],
      onChapterExit: [
        {
          layer: 'jacarezinho-full',
          opacity: 0,
        }
      ]
    }, ]
  };

  // ------------------------------------------
  // DELETE ISSO PARA JOGAR EM PRODUÇÃO
  // ------------------------------------------
  createLocalRecords(config);
  // ------------------------------------------
  // DELETE ISSO PARA JOGAR EM PRODUÇÃO
  // ------------------------------------------

  var layerTypes = {
    'fill': ['fill-opacity'],
    'line': ['line-opacity'],
    'circle': ['circle-opacity', 'circle-stroke-opacity'],
    'symbol': ['icon-opacity', 'text-opacity'],
    'raster': ['raster-opacity'],
    'fill-extrusion': ['fill-extrusion-opacity'],
    'heatmap': ['heatmap-opacity']
  }

  function getLayerPaintType(layer) {
    var layerType = map.getLayer(layer).type;
    return layerTypes[layerType];
  }

  function setLayerOpacity(layer) {
    var paintProps = getLayerPaintType(layer.layer);
    paintProps.forEach(function(prop) {
      var options = {};
      if (layer.duration) {
        var transitionProp = prop + "-transition";
        options = {
          "duration": layer.duration
        };
        map.setPaintProperty(layer.layer, transitionProp, options);
      }
      map.setPaintProperty(layer.layer, prop, layer.opacity, options);
    });
  }

  mapboxgl.accessToken = config.accessToken;

  console.log('Here1')
  var map = new mapboxgl.Map({
    container: 'map',
    style: config.style,
    center: config.chapters[0].location.center,
    zoom: config.chapters[0].location.zoom,
    bearing: config.chapters[0].location.bearing,
    pitch: config.chapters[0].location.pitch,
    interactive: false
  });

  console.log('Here2')
  // instantiate the scrollama
  var scroller = scrollama();

  map.on("load", function() {
    if (config.use3dTerrain) {
      map.addSource('mapbox-dem', {
        'type': 'raster-dem',
        'url': 'mapbox://mapbox.mapbox-terrain-dem-v1',
        'tileSize': 512,
        'maxzoom': 14
      });
      // add the DEM source as a terrain layer with exaggerated height
      map.setTerrain({
        'source': 'mapbox-dem',
        'exaggeration': 1.5
      });

      // add a sky layer that will show when the map is highly pitched
      map.addLayer({
        'id': 'sky',
        'type': 'sky',
        'paint': {
          'sky-type': 'atmosphere',
          'sky-atmosphere-sun': [0.0, 0.0],
          'sky-atmosphere-sun-intensity': 15
        }
      });
    };

    // setup the instance, pass callback functions
    scroller
      .setup({
      step: '.section',
      offset: 0.5,
    })
      .onStepEnter(response => {
      console.log(response)
      var chapter = config.chapters.find(chap => chap.id === response.element.id);
      console.log(chapter)
      response.element.classList.add('active');
      map[chapter.mapAnimation || 'flyTo'](chapter.location);
      if (chapter.onChapterEnter.length > 0) {
        chapter.onChapterEnter.forEach(setLayerOpacity);
      }
      if (chapter.callback) {
        window[chapter.callback](chapter);
      }

      if (chapter.rotateAnimation !== undefined) {
        map.once('moveend', function() {
          const rotateNumber = map.getBearing();
          map.rotateTo(rotateNumber + chapter.rotateAnimation.degrees, {
            duration: chapter.rotateAnimation.duration * 1000, // milliseconds
            easing: function(t) {
              return t;
            }
          });
        });
      }
    })
      .onStepExit(response => {
      var chapter = config.chapters.find(chap => chap.id === response.element.id);
      if (chapter.onChapterExit.length > 0) {
        chapter.onChapterExit.forEach(setLayerOpacity);
      }
    });
  });

  // setup resize event
  window.addEventListener('resize', scroller.resize);
</script>


<!-- ------------------------------------------
Copie até aqui o body
------------------------------------------ -->
</body>